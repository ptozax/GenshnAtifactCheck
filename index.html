<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Artifact Checker</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;900&family=Rajdhani:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --gold:#c8a96e;--gold-bright:#f0d080;--gold-dim:#7a6040;
    --bg-deep:#0a0906;--bg-panel:#13110d;--bg-card:#1c1810;
    --border:#2e2516;--border-gold:#4a3820;
    --text:#d4c4a0;--text-dim:#7a6a50;
    --green:#5cba7c;--purple:#a07adc;--red:#c85050;--blue:#6aabdc;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Rajdhani',sans-serif;background:var(--bg-deep);color:var(--text);min-height:100vh;transition:background-color 0.6s ease;}
  body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;transition:background 0.6s ease;
    background:radial-gradient(ellipse 80% 50% at 50% 0%,rgba(200,169,110,0.06) 0%,transparent 60%),
               radial-gradient(ellipse 40% 60% at 80% 80%,rgba(100,80,200,0.04) 0%,transparent 50%);}

  body.status-not-found{background-color:#1a0505;}
  body.status-not-found::before{background:
    radial-gradient(ellipse 100% 60% at 50% 0%,rgba(200,50,50,0.35) 0%,transparent 70%),
    radial-gradient(ellipse 60% 80% at 50% 100%,rgba(180,30,30,0.20) 0%,transparent 70%);}

  body.status-found-2{background-color:#050f08;}
  body.status-found-2::before{background:
    radial-gradient(ellipse 100% 60% at 50% 0%,rgba(60,200,100,0.30) 0%,transparent 70%),
    radial-gradient(ellipse 60% 80% at 50% 100%,rgba(40,160,80,0.18) 0%,transparent 70%);}

  body.status-found-3{background-color:#08050f;}
  body.status-found-3::before{background:
    radial-gradient(ellipse 100% 60% at 50% 0%,rgba(180,100,255,0.45) 0%,transparent 65%),
    radial-gradient(ellipse 80% 80% at 20% 80%,rgba(120,60,220,0.30) 0%,transparent 60%),
    radial-gradient(ellipse 60% 60% at 80% 60%,rgba(200,80,255,0.25) 0%,transparent 60%);}
  @keyframes pulse-found3{0%,100%{opacity:1}50%{opacity:0.55}}
  body.status-found-3::before{animation:pulse-found3 1.6s ease infinite;}
  .app{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:18px 20px;}
  header{text-align:center;margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--border-gold);position:relative;}
  header::after{content:'';position:absolute;bottom:-1px;left:50%;transform:translateX(-50%);width:180px;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
  .title-main{font-family:'Cinzel',serif;font-size:1.75rem;font-weight:900;background:linear-gradient(135deg,var(--gold-dim) 0%,var(--gold-bright) 50%,var(--gold-dim) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:0.12em;text-transform:uppercase;}
  .title-sub{font-size:0.76rem;color:var(--text-dim);letter-spacing:0.22em;text-transform:uppercase;margin-top:3px;}
  .tabs{display:flex;gap:2px;background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:3px;margin-bottom:16px;}
  .tab-btn{flex:1;padding:7px 12px;background:none;border:none;color:var(--text-dim);font-family:'Rajdhani',sans-serif;font-size:0.82rem;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;border-radius:6px;transition:all 0.2s;}
  .tab-btn.active{background:var(--bg-card);color:var(--gold);border:1px solid var(--border-gold);}
  .tab-btn:hover:not(.active){color:var(--text);}
  .tab-content{display:none;} .tab-content.active{display:block;}
  .two-col{display:grid;grid-template-columns:1.15fr 0.85fr;gap:14px;}
  @media(max-width:720px){.two-col{grid-template-columns:1fr;}}
  .panel-card{background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:12px;}
  .panel-card:last-child{margin-bottom:0;}
  .panel-title{font-family:'Cinzel',serif;font-size:0.7rem;color:var(--gold-dim);letter-spacing:0.2em;text-transform:uppercase;margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px;}
  .btn-row{display:flex;gap:7px;margin-bottom:10px;}
  .btn{padding:8px 13px;border-radius:7px;font-family:'Rajdhani',sans-serif;font-size:0.8rem;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;transition:all 0.2s;border:1px solid;flex:1;}
  .btn-primary{background:linear-gradient(135deg,#2a2010,#3a2e18);border-color:var(--gold-dim);color:var(--gold);}
  .btn-primary:hover:not(:disabled){border-color:var(--gold);box-shadow:0 0 16px rgba(200,169,110,0.18);}
  .btn-danger{background:rgba(200,80,80,0.08);border-color:rgba(200,80,80,0.3);color:#c87070;}
  .btn-danger:hover:not(:disabled){background:rgba(200,80,80,0.15);border-color:rgba(200,80,80,0.55);}
  .btn-secondary{background:rgba(200,169,110,0.05);border-color:var(--border-gold);color:var(--text-dim);}
  .btn-secondary:hover:not(:disabled){color:var(--text);border-color:var(--gold-dim);}
  .btn-full{width:100%;flex:none;} .btn:disabled{opacity:0.3;cursor:not-allowed;}
  #screen-preview-wrap{position:relative;background:#060504;border:1px solid var(--border);border-radius:7px;overflow:hidden;margin-bottom:8px;min-height:110px;display:flex;align-items:center;justify-content:center;}
  @keyframes pulse-border{0%,100%{box-shadow:0 0 0 0 rgba(200,169,110,0)}50%{box-shadow:0 0 0 3px rgba(200,169,110,0.22)}}
  #screen-preview-wrap.live{animation:pulse-border 1.8s ease infinite;}
  #screen-canvas{width:100%;display:none;max-height:300px;object-fit:contain;}
  video{display:none;}
  .placeholder{padding:26px;text-align:center;color:var(--text-dim);font-size:0.78rem;}
  .placeholder .big{font-size:2rem;margin-bottom:7px;}
  .overlay-container{position:absolute;inset:0;pointer-events:none;}
  .rbox{position:absolute;border:1.5px solid;border-radius:3px;}
  .rbox.main-box{border-color:rgba(200,169,110,0.85);background:rgba(200,169,110,0.07);}
  .rbox.sub-box{border-color:rgba(92,186,124,0.75);background:rgba(92,186,124,0.05);}
  .rlabel{position:absolute;top:1px;left:3px;font-size:8px;font-family:'Rajdhani',sans-serif;font-weight:600;opacity:0.9;}
  .live-badge{display:none;align-items:center;gap:5px;position:absolute;top:7px;right:8px;background:rgba(92,186,124,0.15);border:1px solid rgba(92,186,124,0.35);border-radius:20px;padding:2px 9px;font-size:0.64rem;font-weight:700;color:var(--green);text-transform:uppercase;}
  .live-badge.show{display:flex;}
  .live-dot{width:6px;height:6px;background:var(--green);border-radius:50%;animation:blink 1s ease infinite;}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
  .scan-timing{font-size:0.67rem;color:var(--text-dim);text-align:right;margin-bottom:6px;min-height:14px;}
  .scan-timing span{color:var(--gold-dim);}
  .upload-zone{border:2px dashed var(--border-gold);border-radius:7px;padding:11px 14px;text-align:center;cursor:pointer;transition:all 0.2s;background:rgba(200,169,110,0.02);font-size:0.74rem;color:var(--text-dim);}
  .upload-zone:hover,.upload-zone.drag-over{border-color:var(--gold-dim);color:var(--text);}
  input[type=file]{display:none;}
  .lang-toggle{display:flex;gap:6px;margin-bottom:10px;}
  .lang-btn{flex:1;padding:7px;border-radius:7px;font-family:'Rajdhani',sans-serif;font-size:0.8rem;font-weight:700;letter-spacing:0.06em;cursor:pointer;transition:all 0.2s;border:1px solid var(--border);background:var(--bg-card);color:var(--text-dim);text-align:center;}
  .lang-btn.active-en{border-color:rgba(200,160,80,0.6);background:rgba(200,160,80,0.1);color:#e0c070;}
  .lang-btn.active-th{border-color:rgba(92,186,124,0.6);background:rgba(92,186,124,0.1);color:var(--green);}
  .status-bar{border-radius:8px;padding:11px 14px;display:flex;align-items:center;gap:10px;transition:all 0.35s;margin-bottom:10px;border:1px solid transparent;min-height:46px;}
  .status-bar.idle{background:var(--bg-card);border-color:var(--border);}
  .status-bar.scanning-st{background:rgba(200,169,110,0.08);border-color:rgba(200,169,110,0.25);}
  .status-bar.not-found{background:rgba(200,80,80,0.1);border-color:rgba(200,80,80,0.3);}
  .status-bar.found-2{background:rgba(92,186,124,0.1);border-color:rgba(92,186,124,0.3);}
  .status-bar.found-3{background:rgba(160,122,220,0.12);border-color:rgba(160,122,220,0.35);}
  .status-icon{font-size:1.2rem;} .status-text{font-size:0.9rem;font-weight:600;}
  .results-list{display:flex;flex-direction:column;gap:5px;}
  .result-row{display:flex;gap:9px;padding:6px 10px;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;animation:fadeUp 0.22s ease;}
  @keyframes fadeUp{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
  .result-label{color:var(--gold-dim);font-weight:600;min-width:44px;font-size:0.68rem;letter-spacing:0.1em;text-transform:uppercase;padding-top:2px;flex-shrink:0;}
  .result-tags{display:flex;flex-wrap:wrap;gap:4px;}
  .tag{padding:2px 7px;border-radius:4px;font-size:0.7rem;font-weight:600;}
  .tag.crit{background:rgba(200,80,80,0.18);border:1px solid rgba(200,80,80,0.35);color:#e08080;}
  .tag.dmg{background:rgba(200,160,80,0.18);border:1px solid rgba(200,160,80,0.35);color:#e0c070;}
  .tag.heal{background:rgba(92,186,124,0.18);border:1px solid rgba(92,186,124,0.35);color:#7dd4a0;}
  .tag.elem{background:rgba(100,160,220,0.18);border:1px solid rgba(100,160,220,0.35);color:#90c8f0;}
  .tag.none{background:rgba(100,90,70,0.1);border:1px solid var(--border);color:var(--text-dim);}
  .spinner{display:inline-block;width:11px;height:11px;border:2px solid var(--gold-dim);border-top-color:var(--gold);border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;margin-right:4px;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .tess-progress{font-size:0.7rem;color:var(--text-dim);margin-bottom:8px;min-height:16px;}
  .tess-progress .bar{height:3px;background:var(--border);border-radius:2px;margin-top:3px;overflow:hidden;}
  .tess-progress .fill{height:100%;background:var(--gold-dim);border-radius:2px;transition:width 0.3s;}
  .debug-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
  @media(max-width:720px){.debug-grid{grid-template-columns:1fr;}}
  .srow{display:flex;align-items:center;gap:7px;padding:7px 11px;background:var(--bg-card);border:1px solid var(--border);border-radius:7px;margin-bottom:7px;}
  .srow label{font-size:0.78rem;font-weight:600;flex-shrink:0;min-width:60px;}
  .srow input[type=range]{flex:1;}
  .sval{font-size:0.76rem;color:var(--gold);min-width:38px;text-align:right;font-weight:600;}
  .toggle-row{display:flex;align-items:center;justify-content:space-between;padding:8px 11px;background:var(--bg-card);border:1px solid var(--border);border-radius:7px;margin-bottom:7px;}
  .toggle-label{font-size:0.8rem;font-weight:600;} .toggle-desc{font-size:0.67rem;color:var(--text-dim);margin-top:1px;}
  .switch{position:relative;width:36px;height:20px;cursor:pointer;flex-shrink:0;}
  .switch input{display:none;}
  .switch-track{position:absolute;inset:0;background:var(--border);border-radius:10px;transition:background 0.2s;}
  .switch input:checked+.switch-track{background:var(--gold-dim);}
  .switch-thumb{position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:3px;left:3px;transition:transform 0.2s;}
  .switch input:checked~.switch-thumb{transform:translateX(16px);background:var(--gold-bright);}
  .region-section{margin-bottom:7px;border:1px solid var(--border);border-radius:7px;overflow:hidden;}
  .region-header{padding:5px 9px;background:var(--bg-card);font-family:'Cinzel',serif;font-size:0.65rem;color:var(--gold-dim);letter-spacing:0.15em;text-transform:uppercase;border-bottom:1px solid var(--border);}
  .region-sliders{padding:7px 9px;display:grid;grid-template-columns:1fr 1fr;gap:5px;}
  .slider-item label{display:block;font-size:0.62rem;color:var(--text-dim);margin-bottom:1px;}
  .slider-row{display:flex;align-items:center;gap:4px;}
  input[type=range]{-webkit-appearance:none;flex:1;height:3px;background:var(--border);border-radius:2px;outline:none;}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;border-radius:50%;background:var(--gold);cursor:pointer;}
  .slider-val{font-size:0.62rem;color:var(--gold-dim);min-width:32px;text-align:right;}
  .crop-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;}
  .crop-cell{background:var(--bg-card);border:1px solid var(--border);border-radius:5px;overflow:hidden;aspect-ratio:3/2;position:relative;}
  .crop-cell-label{position:absolute;top:2px;left:4px;font-size:0.58rem;color:var(--gold-dim);font-family:'Cinzel',serif;z-index:1;}
  .crop-cell canvas{width:100%;height:100%;object-fit:contain;display:block;}
  .crop-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:0.58rem;color:var(--text-dim);}
  .log-box{background:#080706;border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-family:'Courier New',monospace;font-size:0.67rem;color:#8a7a60;height:120px;overflow-y:auto;line-height:1.5;}
  .log-info{color:#7a8a6a;}.log-warn{color:#c8a060;}.log-found{color:#5cba7c;}.log-err{color:#c87070;}
  .save-btn{width:100%;padding:7px;background:rgba(200,169,110,0.07);border:1px solid var(--border-gold);border-radius:6px;color:var(--gold-dim);font-family:'Rajdhani',sans-serif;font-size:0.76rem;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:all 0.2s;margin-top:6px;}
  .save-btn:hover{color:var(--gold);border-color:var(--gold);}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-main">‚¨° Artifact Checker</div>
    <div class="title-sub">Genshin Impact ‚Äî Tesseract OCR ¬∑ TH / EN</div>
  </header>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('main',this)">Main</button>
    <button class="tab-btn" onclick="switchTab('debug',this)">Debug</button>
  </div>

  <div id="tab-main" class="tab-content active">
    <div class="two-col">
      <div>
        <div class="panel-card">
          <div class="panel-title">Screen Capture</div>
          <div class="lang-toggle">
            <div class="lang-btn active-en" id="btnLangEN" onclick="setLang('en')">üá¨üáß English</div>
            <div class="lang-btn" id="btnLangTH" onclick="setLang('th')">üáπüá≠ ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</div>
          </div>
          <div id="subsToggleRow" class="toggle-row" style="margin-bottom:10px;">
            <div>
              <div class="toggle-label">Scan Subs as one box</div>
              <div class="toggle-desc">EN: OCR ‡∏ó‡∏±‡πâ‡∏á 4 Sub ‡∏£‡∏ß‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤)</div>
            </div>
            <label class="switch">
              <input type="checkbox" id="scanOneBox" checked onchange="scanOneBox=this.checked">
              <div class="switch-track"></div><div class="switch-thumb"></div>
            </label>
          </div>
          <div class="tess-progress" id="tessProgress">
            <span id="tessMsg">Tesseract ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ Scan ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)</span>
            <div class="bar"><div class="fill" id="tessBar" style="width:0%"></div></div>
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" id="btnStart" onclick="startCapture()">‚ñ∂ Start Capture</button>
            <button class="btn btn-danger" id="btnStop" onclick="stopCapture()" disabled>‚ñ† Stop</button>
          </div>
          <div id="screen-preview-wrap">
            <div class="placeholder" id="previewPlaceholder">
              <div class="big">üéÆ</div>
              ‡∏Å‡∏î Start Capture ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Genshin Impact
            </div>
            <canvas id="screen-canvas"></canvas>
            <div class="overlay-container" id="regionOverlay"></div>
            <div class="live-badge" id="liveBadge"><div class="live-dot"></div>LIVE</div>
          </div>
          <div class="scan-timing" id="scanTiming"></div>
          <button class="btn btn-secondary btn-full" id="btnManualScan" onclick="runScan()" disabled style="margin-bottom:9px">‚ú¶ Manual Scan</button>
          <div class="upload-zone" id="uploadZone">üìÅ Drop / Click ‚Äî Upload screenshot (fallback)</div>
          <input type="file" id="fileInput" accept="image/*" onchange="handleScreenFile(event)">
        </div>
      </div>
      <div>
        <div class="panel-card">
          <div class="panel-title">Status</div>
          <div class="status-bar idle" id="statusBar">
            <span class="status-icon">‚¨°</span>
            <span class="status-text" id="statusText">‡∏£‡∏≠ capture...</span>
          </div>
        </div>
        <div class="panel-card">
          <div class="panel-title">OCR Results</div>
          <div class="results-list" id="resultsList">
            <div style="color:var(--text-dim);font-size:0.76rem;text-align:center;padding:12px 0">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-debug" class="tab-content">
    <div class="debug-grid">
      <div>
        <div class="panel-card">
          <div class="panel-title">Settings</div>
          <div class="srow">
            <label>Interval</label>
            <input type="range" min="100" max="5000" step="100" value="100" id="intervalSlider"
              oninput="scanInterval=parseInt(this.value);restartLoop();this.nextElementSibling.textContent=this.value+'ms'">
            <span class="sval">100ms</span>
          </div>
          <div class="srow">
            <label>Diff %</label>
            <input type="range" min="0.00" max="0.1" step="0.005" value="0.005" id="diffSlider"
              oninput="diffThreshold=parseFloat(this.value);this.nextElementSibling.textContent=(this.value*100).toFixed(1)+'%'">
            <span class="sval" style="color:var(--text-dim)">0.5%</span>
          </div>
          <div class="toggle-row">
            <div><div class="toggle-label">Show Overlay</div><div class="toggle-desc">‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≠‡∏ö region ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</div></div>
            <label class="switch"><input type="checkbox" id="overlayToggle" checked onchange="document.getElementById('regionOverlay').style.display=this.checked?'':'none'"><div class="switch-track"></div><div class="switch-thumb"></div></label>
          </div>
        </div>
        <div class="panel-card">
          <div class="panel-title">Region Config (x, y, w, h ‚Äî ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô 0‚Äì1)</div>
          <div id="regionSliders" style="max-height:360px;overflow-y:auto;"></div>
          <button class="save-btn" onclick="saveConfig()">üíæ Save Config</button>
        </div>
      </div>
      <div>
        <div class="panel-card">
          <div class="panel-title">Crop Preview</div>
          <div class="crop-grid" id="cropGrid"></div>
        </div>
        <div class="panel-card">
          <div class="panel-title">Log</div>
          <div class="log-box" id="logBox">
            <span class="log-info">[INFO] Artifact Checker ready ‚Äî Tesseract only mode</span><br>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<video id="hidden-video" autoplay muted playsinline></video>
<script>
let regionConfig = {
  "Main": [0.616, 0.306, 0.14,  0.03 ],
  "Subs": [0.638, 0.493, 0.2,   0.15 ],
  "Sub1": [0.638, 0.49,  0.2,   0.04 ],
  "Sub2": [0.638, 0.525, 0.2,   0.04 ],
  "Sub3": [0.638, 0.56,  0.2,   0.04 ],
  "Sub4": [0.638, 0.598, 0.2,   0.04 ],
};

const KW = {
  en: {
    main: [
      // "HP%",
      // "ATK%",
      // "DEF%",
      "Elemental Mastery",
      "Energy Recharge",
      "Physical DMG Bonus",
      "Pyro DMG Bonus",
      "Hydro DMG Bonus",
      "Electro DMG Bonus",
      "Cryo DMG Bonus",
      "Anemo DMG Bonus",
      "Geo DMG Bonus",
      "Dendro DMG Bonus",
      "Crit Rate",
      "Crit DMG",
      "Healing Bonus"
    ],
    sub: [
      // "HP",
      // "HP%",
      // "ATK",
      // "ATK%",
      // "DEF",
      // "DEF%",
      // "Elemental Mastery",
      // "Energy Recharge",
      "Crit Rate",
      "Crit DMG"
    ],
  },
  th: {
    main: [
      // "‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï",
      // "‡∏û‡∏•‡∏±‡∏á‡πÇ‡∏à‡∏°‡∏ï‡∏µ",
      // "‡∏û‡∏•‡∏±‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô",
      "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏ò‡∏≤‡∏ï‡∏∏",
      "‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô",
      "‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û",
      "‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÑ‡∏ü",
      "‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏ô‡πâ‡∏≥",
      "‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÑ‡∏ü‡∏ü‡πâ‡∏≤",
      "‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á",
      "‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏•‡∏°",
      "‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏¥‡∏ô",
      "‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÑ‡∏°‡πâ",
      "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏¥",
      "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ñ‡∏£‡∏¥",
      "‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤"
    ],
    sub: [
      // "‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï",
      // "‡∏û‡∏•‡∏±‡∏á‡πÇ‡∏à‡∏°‡∏ï‡∏µ",
      // "‡∏û‡∏•‡∏±‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô",
      // "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏ò‡∏≤‡∏ï‡∏∏",
      // "‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô",
      "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏¥",
      "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ñ‡∏£‡∏¥"
    ]
  }
};

let lang = 'en', scanOneBox = true, scanInterval = 1000, diffThreshold = 0.025;
let mediaStream = null, liveLoopTimer = null, lastGrayData = null;
let isOcrBusy = false, currentStaticImage = null;
const workers = { en: null, th: null };
let workerLoading = { en: false, th: false };

const video  = document.getElementById('hidden-video');
const canvas = document.getElementById('screen-canvas');
const ctx    = canvas.getContext('2d', { willReadFrequently: true });

function setLang(l) {
  lang = l;
  document.getElementById('btnLangEN').className = 'lang-btn' + (l==='en' ? ' active-en' : '');
  document.getElementById('btnLangTH').className = 'lang-btn' + (l==='th' ? ' active-th' : '');
  const row = document.getElementById('subsToggleRow');
  if (l === 'th') { scanOneBox = false; document.getElementById('scanOneBox').checked = false; row.style.display = 'none'; }
  else { row.style.display = 'flex'; }
  log(`[INFO] Language: ${l === 'en' ? 'English' : 'Thai'}`);
  getWorker(l);
}

function switchTab(tab, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
}

async function startCapture() {
  try {
    const stream = await navigator.mediaDevices.getDisplayMedia({ video: { frameRate: 10 }, audio: false });
    mediaStream = stream;
    video.srcObject = stream;
    await new Promise(res => { if (video.readyState >= 2) { res(); return; } video.onloadedmetadata = res; });
    await video.play().catch(() => {});
    canvas.width  = video.videoWidth  || 1920;
    canvas.height = video.videoHeight || 1080;
    canvas.style.display = 'block';
    document.getElementById('previewPlaceholder').style.display = 'none';
    document.getElementById('screen-preview-wrap').classList.add('live');
    document.getElementById('liveBadge').classList.add('show');
    document.getElementById('btnStart').disabled = true;
    document.getElementById('btnStop').disabled  = false;
    document.getElementById('btnManualScan').disabled = false;
    stream.getVideoTracks()[0].addEventListener('ended', stopCapture);
    log(`[INFO] Capture started (${canvas.width}x${canvas.height})`);
    startLiveLoop();
  } catch (err) {
    log(`[ERR] getDisplayMedia: ${err.message}`);
    setStatus('not-found', '‚ùå', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ capture ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠');
  }
}

function stopCapture() {
  if (liveLoopTimer) { clearInterval(liveLoopTimer); liveLoopTimer = null; }
  if (mediaStream)   { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
  lastGrayData = null;
  canvas.style.display = 'none';
  document.getElementById('previewPlaceholder').style.display = '';
  document.getElementById('screen-preview-wrap').classList.remove('live');
  document.getElementById('liveBadge').classList.remove('show');
  document.getElementById('btnStart').disabled = false;
  document.getElementById('btnStop').disabled  = true;
  document.getElementById('btnManualScan').disabled = !currentStaticImage;
  document.getElementById('scanTiming').innerHTML = '';
  setStatus('idle', '‚¨°', '‡∏´‡∏¢‡∏∏‡∏î capture');
  log('[INFO] Capture stopped');
}

function startLiveLoop() { if (liveLoopTimer) clearInterval(liveLoopTimer); liveLoopTimer = setInterval(liveFrame, scanInterval); }
function restartLoop()   { if (mediaStream) startLiveLoop(); }

async function liveFrame() {
  if (!mediaStream || isOcrBusy || video.readyState < 2) return;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  drawOverlay();
  const diffRegion = (lang === 'en' && scanOneBox) ? 'Subs' : 'Sub1';
  const [rx, ry, rw, rh] = regionConfig[diffRegion];
  const sx = Math.floor(rx * canvas.width),  sy = Math.floor(ry * canvas.height);
  const sw = Math.floor(rw * canvas.width),  sh = Math.floor(rh * canvas.height);
  if (sw < 4 || sh < 4) return;
  const gray = toGray(ctx.getImageData(sx, sy, sw, sh).data);
  if (lastGrayData && lastGrayData.length === gray.length) {
    let diff = 0;
    for (let i = 0; i < gray.length; i++) diff += Math.abs(gray[i] - lastGrayData[i]);
    if (diff / (sw * sh * 255) < diffThreshold) return;
  }
  lastGrayData = gray;
  isOcrBusy = true;
  const t0 = performance.now();
  await runScan();
  document.getElementById('scanTiming').innerHTML = `Last OCR: <span>${(performance.now()-t0).toFixed(0)}ms</span> | Œî triggered`;
  isOcrBusy = false;
}

function toGray(rgba) {
  const g = new Uint8Array(rgba.length / 4);
  for (let i = 0, j = 0; i < rgba.length; i += 4, j++)
    g[j] = (rgba[i] * 77 + rgba[i+1] * 150 + rgba[i+2] * 29) >> 8;
  return g;
}

function drawOverlay() {
  const ov = document.getElementById('regionOverlay');
  ov.innerHTML = '';
  const cW = canvas.offsetWidth, cH = canvas.offsetHeight;
  if (!cW || !cH) return;
  const colors = { Main:'rgba(200,169,110,0.9)', Subs:'rgba(160,122,220,0.8)', Sub1:'rgba(92,186,124,0.8)', Sub2:'rgba(92,186,124,0.8)', Sub3:'rgba(92,186,124,0.8)', Sub4:'rgba(92,186,124,0.8)' };
  for (const [name, [rx, ry, rw, rh]] of Object.entries(regionConfig)) {
    if (name === 'Subs' && !(lang === 'en' && scanOneBox)) continue;
    if (['Sub1','Sub2','Sub3','Sub4'].includes(name) && lang === 'en' && scanOneBox) continue;
    const box = document.createElement('div');
    box.className = 'rbox ' + (name === 'Main' ? 'main-box' : 'sub-box');
    box.style.cssText = `left:${rx*cW}px;top:${ry*cH}px;width:${rw*cW}px;height:${rh*cH}px`;
    box.innerHTML = `<span class="rlabel" style="color:${colors[name]}">${name}</span>`;
    ov.appendChild(box);
  }
}

async function runScan() {
  const hasLive = !!mediaStream, hasStatic = !!currentStaticImage;
  if (!hasLive && !hasStatic) return;
  const W = hasLive ? canvas.width  : currentStaticImage.naturalWidth;
  const H = hasLive ? canvas.height : currentStaticImage.naturalHeight;
  const src = hasLive ? canvas : currentStaticImage;
  if (!hasLive && hasStatic) {
    canvas.width = W; canvas.height = H;
    ctx.drawImage(currentStaticImage, 0, 0);
    canvas.style.display = 'block';
    document.getElementById('previewPlaceholder').style.display = 'none';
    drawOverlay();
  }
  if (!hasLive) setStatus('scanning-st', '<span class="spinner"></span>', '‡∏Å‡∏≥‡∏•‡∏±‡∏á OCR...');
  const cropCanvas = document.createElement('canvas');
  const cropCtx    = cropCanvas.getContext('2d');
  const results    = {};
  const subRegions = (lang === 'en' && scanOneBox) ? ['Subs'] : ['Sub1','Sub2','Sub3','Sub4'];
  const regions    = ['Main', ...subRegions];
  for (const [name, [rx, ry, rw, rh]] of Object.entries(regionConfig)) {
    if (!regions.includes(name)) continue;
    const cx = Math.floor(rx * W), cy = Math.floor(ry * H);
    const cw = Math.floor(rw * W), ch = Math.floor(rh * H);
    if (cw < 4 || ch < 4) continue;
    cropCanvas.width = cw; cropCanvas.height = ch;
    cropCtx.drawImage(src, cx, cy, cw, ch, 0, 0, cw, ch);
    updateCropCell(name, cropCanvas);
    const ocrCanvas = prepareForOCR(cropCanvas);
    try {
      const text = await ocrWithTesseract(ocrCanvas.toDataURL('image/png'));
      results[name] = filterText(text, name);
      log(`[OCR] ${name}: "${text.trim().substring(0,60).replace(/\n/g,' | ')}" ‚Üí ${JSON.stringify(results[name])}`);
    } catch(e) {
      results[name] = [];
      log(`[ERR] OCR ${name}: ${e.message}`);
    }
  }
  displayResults(results);
}

function prepareForOCR(src) {
  const SCALE = 3;
  const w = src.width * SCALE;
  const h = src.height * SCALE;

  const canvas = document.createElement('canvas');
  canvas.width = w;
  canvas.height = h;

  const ctx = canvas.getContext('2d');
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(src, 0, 0, w, h);

  let imgData = ctx.getImageData(0, 0, w, h);
  let d = imgData.data;

  // 1Ô∏è‚É£ ‡πÄ‡∏û‡∏¥‡πà‡∏° contrast ‡∏Å‡πà‡∏≠‡∏ô
  const contrast = 80; // ‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö 50-120
  const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));

  for (let i = 0; i < d.length; i += 4) {
    let r = d[i];
    let g = d[i + 1];
    let b = d[i + 2];

    // grayscale
    let gray = (r * 77 + g * 150 + b * 29) >> 8;

    // contrast boost
    gray = factor * (gray - 128) + 128;

    // 2Ô∏è‚É£ adaptive threshold ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
    let v = gray > 160 ? 255 : 0;

    // 3Ô∏è‚É£ invert ‡∏ñ‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏°
    v = 255 - v;

    d[i] = d[i + 1] = d[i + 2] = v;
  }

  ctx.putImageData(imgData, 0, 0);
  return canvas;
}

async function getWorker(l) {
  if (workers[l]) return workers[l];
  if (workerLoading[l]) { while (workerLoading[l]) await sleep(120); return workers[l]; }
  workerLoading[l] = true;
  await loadScript('https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract.min.js');
  const tessLang = l === 'th' ? 'tha' : 'eng';
  log(`[INFO] Loading Tesseract "${tessLang}"...`);
  setTessProgress(10, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Tesseract (${tessLang})...`);
  workers[l] = await Tesseract.createWorker(tessLang, 1, {
    logger: m => {
      if (m.status === 'loading tesseract core')       setTessProgress(20, 'Loading core...');
      if (m.status === 'initializing tesseract')       setTessProgress(40, 'Initializing...');
      if (m.status === 'loading language traineddata') setTessProgress(60, `Loading ${tessLang} data...`);
      if (m.status === 'initialized api')              setTessProgress(100, '‚úì Tesseract ready');
    }
  });
  if (l === 'th') await workers[l].setParameters({ tessedit_pageseg_mode: '6' });
  workerLoading[l] = false;
  log(`[INFO] Tesseract (${tessLang}) ready`);
  setTessProgress(100, `‚úì Tesseract (${tessLang}) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô`);
  return workers[l];
}

async function ocrWithTesseract(dataUrl) {
  const w = await getWorker(lang);
  const { data: { text } } = await w.recognize(dataUrl);
  return text;
}

function loadScript(src) {
  return new Promise((res, rej) => {
    if (document.querySelector(`script[src="${src}"]`)) { res(); return; }
    const s = document.createElement('script');
    s.src = src; s.onload = res; s.onerror = rej;
    document.head.appendChild(s);
  });
}

function setTessProgress(pct, msg) {
  document.getElementById('tessMsg').textContent = msg;
  document.getElementById('tessBar').style.width = pct + '%';
}

// ============================================================
// FUZZY MATCH
// ============================================================
function bigramSim(a, b) {
  if (a.length < 2 || b.length < 2) return 0;
  const bg = s => { const r = []; for (let i=0;i<s.length-1;i++) r.push(s.slice(i,i+2)); return r; };
  const bA = bg(a), bB = [...bg(b)];
  let hits = 0;
  for (const x of bA) { const i = bB.indexOf(x); if (i !== -1) { hits++; bB.splice(i, 1); } }
  return (2 * hits) / (bA.length + bg(b).length);
}

function charOverlap(line, kw) {
  const pool = [...line]; let hits = 0;
  for (const c of kw) { const i = pool.indexOf(c); if (i !== -1) { hits++; pool.splice(i, 1); } }
  return hits / kw.length;
}

function bestKeywordMatch(line, kws, regionName) {
  const clean = s => s.replace(/[0-9+\-%.\/\s]/g, '');
  const lineC = clean(line);

  // Negative guard ‚Äî ‡∏ñ‡πâ‡∏≤ line ‡∏°‡∏µ‡∏Ñ‡∏≥‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ ‡∏´‡πâ‡∏≤‡∏° match keyword ‡∏ö‡∏≤‡∏á‡∏ï‡∏±‡∏ß
  const NEGATIVE_GUARDS = [
    { linePattern: /‡∏ä‡πç‡∏≤|‡∏ä‡∏≥|‡∏ô‡∏≤‡∏ç|‡∏ä‡∏≤‡∏ô/,  blockKw: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ñ‡∏£‡∏¥' },
    { linePattern: /‡∏ä‡πç‡∏≤|‡∏ä‡∏≥|‡∏ô‡∏≤‡∏ç|‡∏ä‡∏≤‡∏ô/,  blockKw: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏¥' },
    { linePattern: /‡∏û‡∏±‡∏ô‡∏ü|‡∏ü‡∏±‡∏ô‡∏ü|‡∏ü‡∏∑‡πâ‡∏ô|‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô/, blockKw: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏¥'  },
    { linePattern: /‡∏û‡∏±‡∏ô‡∏ü|‡∏ü‡∏±‡∏ô‡∏ü|‡∏ü‡∏∑‡πâ‡∏ô|‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô/, blockKw: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ñ‡∏£‡∏¥' },
  ];

  let best = null, bestScore = 0;

  for (const kw of kws) {
    const kwC = clean(kw);
    if (!kwC) continue;

    // ‡∏ï‡∏£‡∏ß‡∏à negative guard ‡∏Å‡πà‡∏≠‡∏ô
    const blocked = NEGATIVE_GUARDS.some(g => g.blockKw === kw && g.linePattern.test(line));
    if (blocked) continue;

    // 1. Exact substring
    if (line.toLowerCase().includes(kw.toLowerCase())) return kw;

    // 2. Char overlap + bigram
    const score = charOverlap(lineC, kwC) * 0.7 + bigramSim(lineC, kwC) * 0.3;
    if (score > bestScore) { bestScore = score; best = kw; }
  }

  const threshold = lang === 'th'
    ? (regionName === 'Main' ? 0.60 : 0.38)
    : 0.60;

  return bestScore >= threshold ? best : null;
}

// Regex patterns ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TH sub ‚Äî ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á
const TH_SUB_PATTERNS = [
  // ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏¥ ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ‡∏≠+‡∏ï/‡∏±+‡∏£ pattern ‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
  { re: /‡∏≠[‡∏±‡∏ï][‡∏ï‡∏£][‡∏≤‡∏Å][‡∏Ñ‡∏Å‡∏î‡∏ñ‡∏£‡∏§]/,        kw: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏¥' , not: /‡∏ä‡πç‡∏≤|‡∏ä‡∏≥|‡∏ô‡∏≤‡∏ç/ },
  { re: /‡∏≠[‡∏¢‡∏Å][‡∏Å‡∏¢]‡πÄ‡∏£‡∏≤|‡∏≠‡∏ï‡πÄ‡∏£‡∏≤|‡∏≠‡∏¢‡πÄ‡∏£‡∏≤/,     kw: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏¥', not: /‡∏ä‡πç‡∏≤|‡∏ä‡∏≥|‡∏ô‡∏≤‡∏ç/  },
  { re: /‡∏≠‡∏ï‡∏£‡∏≤[‡∏Ñ‡∏Å‡∏î‡∏ñ‡∏£]/,                   kw: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏¥' , not: /‡∏ä‡πç‡∏≤|‡∏ä‡∏≥|‡∏ô‡∏≤‡∏ç/ },

  // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ñ‡∏£‡∏¥ ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ‡πÅ‡∏£‡∏á/‡πÅ‡∏£‡∏á ‡πÅ‡∏•‡∏∞ ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ ‡∏ä‡πç‡∏≤‡∏ô‡∏≤‡∏ç/‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç/‡∏ô‡∏≤‡∏ç ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢
  { re: /[‡∏Ñ‡∏î‡∏ñ‡∏Å]‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á[‡∏Ñ‡∏Å‡∏î‡∏ñ‡∏ï‡∏£‡∏§]/,         kw: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ñ‡∏£‡∏¥', not: /‡∏ä‡πç‡∏≤|‡∏ä‡∏≥|‡∏ô‡∏≤‡∏ç/ },
  { re: /[‡∏Ñ‡∏î‡∏ñ‡∏Å]‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢[‡∏Ñ‡∏Å‡∏î‡∏ñ‡∏ï‡∏£]/,      kw: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ñ‡∏£‡∏¥', not: /‡∏ä‡πç‡∏≤|‡∏ä‡∏≥|‡∏ô‡∏≤‡∏ç/ },
];

function filterText(rawText, regionName) {
  const kws   = regionName === 'Main' ? KW[lang].main : KW[lang].sub;
  const lines = rawText.split('\n').map(l => l.trim()).filter(l => l.length > 1);
  const matched = [];
  for (const line of lines) {
    let kw = null;
    if (lang === 'th' && regionName !== 'Main') {
      for (const p of TH_SUB_PATTERNS) {
        if (p.re.test(line) && kws.includes(p.kw) && !(p.not && p.not.test(line))) {
          kw = p.kw; break;
        }
      }
    }
    if (!kw) kw = bestKeywordMatch(line, kws, regionName);
    if (kw) {
      log(`[MATCH] "${line}" ‚Üí "${kw}"`);
      matched.push(kw);
    } else if (lang === 'th') {
      const clean = s => s.replace(/[0-9+\-%.\/\s]/g, '');
      const lineC = clean(line);
      let dbg = '';
      for (const k of kws) {
        const sc = (charOverlap(lineC, clean(k)) * 0.7 + bigramSim(lineC, clean(k)) * 0.3).toFixed(2);
        dbg += ` [${k.slice(0,4)}:${sc}]`;
      }
      log(`[DBG] "${line.slice(0,22)}"${dbg}`);
    }
  }
  return [...new Set(matched)];
}

// ============================================================
// DISPLAY
// ============================================================
function displayResults(results) {
  const list = document.getElementById('resultsList');
  list.innerHTML = '';
  let found = 0;
  for (const [name, texts] of Object.entries(results)) {
    const row = document.createElement('div');
    row.className = 'result-row';
    const tags = texts.length
      ? texts.map(t => `<span class="tag ${tagClass(t)}">${t}</span>`).join('')
      : `<span class="tag none">‚Äî</span>`;
    row.innerHTML = `<span class="result-label">${name}</span><div class="result-tags">${tags}</div>`;
    list.appendChild(row);
    found += texts.length;
  }
  if (found === 0)     setStatus('not-found', '‚ùå', '‡πÑ‡∏°‡πà‡∏û‡∏ö Sub ‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à');
  else if (found >= 3) setStatus('found-3', 'üíé', `‡∏û‡∏ö ${found} ‚Äî Rare ATF! üéâ`);
  else if (found >= 2) setStatus('found-2', '‚úÖ', `‡∏û‡∏ö ${found} Sub ‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à`);
  else                 etStatus('not-found', '‚ùå', `‡∏û‡∏ö ${found} Sub ‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à`)
}

function tagClass(t) {
  if (t === 'Crit Rate'   || t === '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏£‡∏¥')   return 'crit';
  if (t === 'Crit DMG'    || t === '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ñ‡∏£‡∏¥')  return 'dmg';
  if (t.includes('Healing')  || t.includes('‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤') || t.includes('‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π')) return 'heal';
  if (t.includes('Mastery')  || t.includes('Recharge')  || t.includes('DMG Bonus') ||
      t.includes('‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç')   || t.includes('‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô')   || t.includes('‡πÇ‡∏ö‡∏ô‡∏±‡∏™'))    return 'elem';
  return 'crit';
}

function setStatus(cls, icon, txt) {
  const bar = document.getElementById('statusBar');
  bar.className = 'status-bar ' + cls;
  bar.querySelector('.status-icon').innerHTML = icon;
  bar.querySelector('#statusText').textContent = txt;
  // Update body background
  document.body.className = document.body.className
    .replace(/\bstatus-\S+/g, '').trim();
  if (cls && cls !== 'idle' && cls !== 'scanning-st')
    document.body.classList.add('status-' + cls);
}

// ============================================================
// CONFIG
// ============================================================
function saveConfig() {
  localStorage.setItem('artifactRegionConfig', JSON.stringify(regionConfig));
  const b = document.querySelector('.save-btn');
  b.textContent = '‚úì Saved!'; b.style.color = 'var(--green)';
  setTimeout(() => { b.textContent = 'üíæ Save Config'; b.style.color = ''; }, 1500);
  log('[INFO] Config saved');
}

function loadSavedConfig() {
  const s = localStorage.getItem('artifactRegionConfig');
  if (s) { try { regionConfig = JSON.parse(s); log('[INFO] Config loaded'); } catch(e) {} }
}

function buildRegionSliders() {
  const con = document.getElementById('regionSliders');
  con.innerHTML = '';
  for (const [key, vals] of Object.entries(regionConfig)) {
    const sec = document.createElement('div'); sec.className = 'region-section';
    sec.innerHTML = `<div class="region-header">${key}</div>`;
    const grid = document.createElement('div'); grid.className = 'region-sliders';
    ['x','y','w','h'].forEach((lbl, i) => {
      const item = document.createElement('div'); item.className = 'slider-item';
      item.innerHTML = `<label>${lbl.toUpperCase()}</label>
        <div class="slider-row">
          <input type="range" min="0" max="1" step="0.001" value="${vals[i]}"
            oninput="updateRegion('${key}',${i},this.value);this.nextElementSibling.textContent=parseFloat(this.value).toFixed(3)">
          <span class="slider-val">${vals[i].toFixed(3)}</span>
        </div>`;
      grid.appendChild(item);
    });
    sec.appendChild(grid); con.appendChild(sec);
  }
}

function updateRegion(key, idx, val) { regionConfig[key][idx] = parseFloat(val); drawOverlay(); }

function buildCropGrid() {
  const g = document.getElementById('cropGrid'); g.innerHTML = '';
  ['Main','Subs','Sub1','Sub2','Sub3','Sub4'].forEach(n => {
    const c = document.createElement('div'); c.className = 'crop-cell'; c.id = 'crop-' + n;
    c.innerHTML = `<div class="crop-cell-label">${n}</div><div class="crop-placeholder">‚Äî</div>`;
    g.appendChild(c);
  });
}

function updateCropCell(name, src) {
  const cell = document.getElementById('crop-' + name); if (!cell) return;
  const c = document.createElement('canvas'); c.width = src.width; c.height = src.height;
  c.getContext('2d').drawImage(src, 0, 0);
  cell.innerHTML = `<div class="crop-cell-label">${name}</div>`;
  cell.appendChild(c);
}

function handleScreenFile(e) { const f = e.target.files[0]; if (f) loadImageFile(f); }
function loadImageFile(file) {
  const r = new FileReader();
  r.onload = ev => {
    const img = new Image();
    img.onload = () => {
      currentStaticImage = img;
      canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
      ctx.drawImage(img, 0, 0);
      canvas.style.display = 'block';
      document.getElementById('previewPlaceholder').style.display = 'none';
      drawOverlay();
      document.getElementById('btnManualScan').disabled = false;
      log(`[INFO] Image loaded: ${img.naturalWidth}x${img.naturalHeight}`);
    };
    img.src = ev.target.result;
  };
  r.readAsDataURL(file);
}

function log(msg) {
  const box = document.getElementById('logBox');
  const sp  = document.createElement('span');
  if      (msg.includes('[INFO]'))  sp.className = 'log-info';
  else if (msg.includes('[WARN]'))  sp.className = 'log-warn';
  else if (msg.includes('[OCR]') || msg.includes('[MATCH]')) sp.className = 'log-found';
  else if (msg.includes('[ERR]'))   sp.className = 'log-err';
  sp.textContent = msg;
  box.appendChild(sp);
  box.appendChild(document.createElement('br'));
  box.scrollTop = box.scrollHeight;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

loadSavedConfig();
buildRegionSliders();
buildCropGrid();

const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('click',     () => document.getElementById('fileInput').click());
uploadZone.addEventListener('dragover',  e  => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault(); uploadZone.classList.remove('drag-over');
  const f = e.dataTransfer.files[0];
  if (f && f.type.startsWith('image/')) loadImageFile(f);
});

new ResizeObserver(() => drawOverlay()).observe(document.getElementById('screen-preview-wrap'));
getWorker('en');
</script>
</body>
</html>